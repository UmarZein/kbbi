#!/usr/bin/env bash

# Script ini untuk mengalih-tuliskan Kamus Besar Bahasa Indonesia edisi IV
# tahun 2008 dari bentuk PDF ke bentuk teks biasa (plain text)
#
# Membutuhkan paket pdftotext, gawk, dan bash (minimal versi 4)
#
# Teks yang dihasilkan script ini masih harus disunting secara manual
#
# LICENSE ----------------------------------------------------------------------
#
# MIT License
#
# Copyright (c) 2017 Sahri Riza Umami
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#
# ------------------------------------------------------------------------------

# VARIABLES --------------------------------------------------------------------

# Skrip ini bergantung pada map sumber yang terletak pada direktori yang sama
# Dapatkan letak di mana skrip berada.
readonly KBBIDIR=$(cd "$(dirname "$0")" || exit; pwd)
readonly KBBI='sumber/Kamus-Besar-Bahasa-Indonesia.pdf'
readonly LEMA='sumber/Lema_Tertinggal_KBBI_Ed._Keempat_Rev_Ver_4.pdf'

# FUNCTIONS --------------------------------------------------------------------

bantuan() {
  printf '%s\n' "
 ${0##*/} adalah skrip Bash untuk mengalihtuliskan Kamus Besar Bahasa Indonesia
 edisi IV tahun 2008 dari bentuk PDF ke bentuk teks biasa (plain text).

 Cara pakai: ${0##*/} PILIHAN

 PILIHAN:
	-a, --alihtulis  Mengalihtuliskan PDF KBBI IV 2008 menjadi berkas teks biasa
	-g, --gabung     Gabungkan berkas teks berdasar huruf lema
  -t, --teks       Ubah berkas PDF KBBI menjadi berkas teks
  -u, --ubah       Perbaiki karakter hasil OCR yang salah
	-h, --help       Tampilkan bantuan ini

 CONTOH:
   ${0##*/} -a
   ${0##*/} --alihtulis
   ${0##*/} -g
   ${0##*/} --gabung
   ${0##*/} -t
   ${0##*/} --teks
   ${0##*/} -u
   ${0##*/} --ubah
   ${0##*/} -h
   ${0##*/} --help
 "
  exit
}

# Tampilkan pesan berupa huruf tebal berwarna hijau
teks_hijau() {
  printf '\e[1;32m:: %s\n\e[m' "$@"
}

# Tampilkan pesan berupa huruf tebal berwarna coklat
teks_coklat() {
  printf '\e[1;33m:: %s\n\e[m' "$@"
}

# Tampilkan pesan berupa huruf tebal berwarna merah
teks_merah() {
  printf '\e[1;31m:: %s\n\e[m' "$@"
}

# Ubah pdf menjadi berkas biasa menggunakan pdftotext
pdf_ke_teks() {
  [[ -d 'teks' ]] || mkdir 'teks'

  local i

	teks_hijau "Mengubah halaman PDF menjadi halaman teks biasa"
  for i in {19..129}; do
    printf ':: %s\r' "- Halaman ${i} -> $0/teks/kbbi4-$i.txt"
    # Halaman untuk lema A memiliki tinggi bagian nomor yang berbeda dengan
    # halaman lainnya (sekitar 600 px pada resolusi 500 dpi)
    pdftotext -f "$i" -l "$i" -r 500 -eol unix -nopgbrk -x 0 -y 600 -W 3250 -H 3636 "$KBBI" teks/kbbi4-"$i".txt
  done

  for i in {130..1490}; do
    printf ':: %s\r' "- Halaman ${i} -> $0/teks/kbbi4-$i.txt"
    pdftotext -f "$i" -l "$i" -r 500 -eol unix -nopgbrk -x 0 -y 436 -W 3250 -H 3800 "$KBBI" teks/kbbi4-"$i".txt
  done

  # Lema_Tertinggal_KBBI_Ed._Keempat_Rev_Ver_4 hanya akan diubah ke teks
  # untuk selanjutnya disunting secara manual
  teks_hijau "Mengubah ${LEMA##*/} menjadi $0/teks/${LEMA##*/}.txt"
  pdftotext -r 500 -eol unix -nopgbrk "$LEMA" teks/"${LEMA##*/}".txt
}

# Kelompokkan kata berdasar huruf awal
kelompokkan_kata() {
  cat teks/kbbi4-{19..129}.txt > teks/kbbi4-A.txt
  cat teks/kbbi4-{130..263}.txt > teks/kbbi4-B.txt
  cat teks/kbbi4-{264..319}.txt > teks/kbbi4-C.txt
  cat teks/kbbi4-{320..390}.txt > teks/kbbi4-D.txt
  cat teks/kbbi4-{391..418}.txt > teks/kbbi4-E.txt
  cat teks/kbbi4-{419..439}.txt > teks/kbbi4-F.txt
  cat teks/kbbi4-{440..516}.txt > teks/kbbi4-G.txt
  cat teks/kbbi4-{517..553}.txt > teks/kbbi4-H.txt
  cat teks/kbbi4-{554..585}.txt > teks/kbbi4-I.txt
  # Tidak ada lema J di berkas PDF KBBI 2008
  #cat teks/kbbi4-{..}.txt > teks/kbbi4-J.txt
  cat teks/kbbi4-{586..764}.txt > teks/kbbi4-K.txt
  cat teks/kbbi4-{765..866}.txt > teks/kbbi4-L.txt
  cat teks/kbbi4-{867..968}.txt > teks/kbbi4-M.txt
  cat teks/kbbi4-{969..989}.txt > teks/kbbi4-N.txt
  cat teks/kbbi4-{990..1002}.txt > teks/kbbi4-O.txt
  # Tidak ada lema P di berkas PDF KBBI 2008
  #cat teks/kbbi4-{..}.txt > teks/kbbi4-P.txt
  cat teks/kbbi4-1003.txt > teks/kbbi4-Q.txt
  cat teks/kbbi4-{1004..1092}.txt > teks/kbbi4-R.txt
  cat teks/kbbi4-{1093..1259}.txt > teks/kbbi4-S.txt
  cat teks/kbbi4-{1260..1430}.txt > teks/kbbi4-T.txt
  cat teks/kbbi4-{1431..1459}.txt > teks/kbbi4-U.txt
  cat teks/kbbi4-{1460..1467}.txt > teks/kbbi4-V.txt
  cat teks/kbbi4-{1468..1481}.txt > teks/kbbi4-W.txt
  cat teks/kbbi4-1482.txt > teks/kbbi4-X.txt
  cat teks/kbbi4-{1483..1485}.txt > teks/kbbi4-Y.txt
  cat teks/kbbi4-{1486..1490}.txt > teks/kbbi4-Z.txt
}

# Perbaiki kata hasil konversi pdftotext
perbaiki_kata() {
  for i in {A..Z}; do
    if [[ -f teks/kbbi4-$i.txt ]]; then
      printf '\e[1;33m:: %s\r\e[m' "Memperbaiki kata di berkas $i"

			# TODO
			# Find a more efficient method to edit teks/kbbi4-*.txt files.
			# gawk's inplace editing below is expensive.
			# At least 7 processes, multiplied by 26 letters, is equal to 182 times
			# it's opening - editing - saving the files. Ugly.

      # KBBI 2008 menggunakan drop cap letter pada halaman awal lema
      # Perintah berikut akan menghapus huruf yang berada di baris 1 tersebut
      gawk -i inplace 'NR>1' "teks/kbbi4-$i.txt"

      # Hapus baris kosong
      gawk -i inplace 'NF' "teks/kbbi4-$i.txt"

      # pdftotext gagal menerjemahkan beberapa karakter
      # Ubah dash (yang aslinya berupa double dash) menjadi double dash
      gawk -i inplace '/ -[[:alnum:]]/{gsub(" -", " -- ")};1' "teks/kbbi4-$i.txt"
      # Ubah tanda kutip
      gawk -i inplace '{gsub("[“”]", "\"")};1' "teks/kbbi4-$i.txt"
      # Ubah ĺ menjadi ->
      gawk -i inplace '{gsub("ĺ", "->")};1' "teks/kbbi4-$i.txt"
      # Ubah o menjadi -> pada baris di bawah 5 kolom
      gawk -i inplace 'NF<5 {gsub(" o ", "->")};1' "teks/kbbi4-$i.txt"

      # KBBI 2008 menggunakan angka di depan lema yang memiliki banyak arti
      # Angka tersebut dirasa tidak penting dan akan dihapus oleh perintah berikut
      gawk -i inplace '!/^[[:digit:]]$/' "teks/kbbi4-$i.txt"

      # Gabung baris berdasar lema
      gawk -v huruf=^"[$i${i,,}]" '$0 ~ huruf {if (x)print x;x="";}{x=(!x)?$0:x" "$0;}END{print x;}' "teks/kbbi4-$i.txt" > "teks/$i.txt"
    fi
  done
}

# MAIN -------------------------------------------------------------------------

# Skrip hanya menerima satu argumen
[[ $# -eq 0 || $# -gt 3 ]] && bantuan

# Periksa ketersediaan program yang dibutuhkan
declare -a DEPS=(pdftotext gawk bash)
for ((NUM=${#DEPS[@]},i=0; i<NUM;i++)); do
  if command -v "${DEPS[i]}" &>/dev/null ; then
    unset -v 'DEPS[i]'
  fi
done

# Hentikan skrip jika program yang dibutuhkan tidak ada dalam sistem
if [[ "${#DEPS[@]}" -gt 0 ]]; then
  teks_merah 'Ada paket yang dibutuhkan tidak ada dalam sistem.'
  teks_coklat 'Pasang paket berikut sesuai distro yang digunakan:'
  printf '   - %s\n' "${DEPS[@]}"
  exit
fi

# Pastikan skrip dijalankan dalam direktorinya (sejajar dengan map sumber)
cd "$KBBIDIR" || exit

if [[ ! -d $KBBIDIR/sumber ]]; then
	teks_merah 'Tidak menemukan map sumber yang berisi berkas PDF KBBI.'
	exit
fi

if [[ -d $KBBIDIR/teks ]]; then
	teks_coklat 'Menemukan map teks yang mungkin berharga.
:: Pindahkan atau hapus map tersebut kemudian jalankan kembali skrip ini.'
	exit
fi

case $1 in
  -a|--alihtulis)
    pdf_ke_teks
    kelompokkan_kata
    perbaiki_kata
    rm teks/kbbi4-*.txt
    teks_hijau 'Selesai.                               '
		teks_coklat "Lihat hasil konversi di: $KBBIDIR/teks"
  ;;
  -g|--gabung)
    kelompokkan_kata
  ;;
  -t|--teks)
    pdf_ke_teks
  ;;
  -u|--ubah)
    perbaiki_kata
  ;;
  -h|--help|*)
    bantuan
  ;;
esac
